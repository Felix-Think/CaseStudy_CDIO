<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Danh sách Case • CaseStudy</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#E6F8F3',
              100: '#C7EEDF',
              200: '#99DFC5',
              500: '#1EA97C',
              600: '#158F69',
              700: '#0F6E4E'
            }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui']
          },
          boxShadow: {
            card: '0 20px 45px -25px rgba(15, 23, 42, 0.35)'
          }
        }
      }
    };
  </script>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body class="min-h-screen font-sans text-slate-800">
  <div class="absolute inset-0 -z-10 bg-gradient-to-br from-primary-50 via-white to-slate-100"></div>

  <div class="relative flex min-h-screen flex-col">
    <header class="sticky top-0 z-40 border-b border-white/40 bg-white/80 backdrop-blur">
      <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-4">
        <div class="flex items-center gap-3 w-full">
          <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary-600 text-sm font-semibold uppercase tracking-widest text-white">TAT</div>
          <div class="flex flex-1 items-center gap-3">
            <p class="text-xs font-semibold uppercase tracking-[0.28em] text-primary-600">CaseStudy</p>
            <h1 class="text-lg font-semibold text-slate-900">Danh sách Case realtime</h1>
          </div>
          <a href="/user" class="text-sm font-semibold text-primary-600 transition hover:text-primary-500 ml-auto">Quay lại trang chính</a>
        </div>
        <nav class="hidden items-center gap-3 md:flex">
          <a href="/" class="btn btn--ghost action-desktop">Trang chá»§</a>
          <a href="/chatframe" class="btn btn--ghost action-desktop">Chat Frame</a>
          <a href="/quan-ly-kho" class="btn btn--ghost action-desktop">Quản lý kho</a>
          <a href="/nhap-case" class="btn btn--primary">Nhập Case</a>
        </nav>
      </div>
    </header>

    <main class="flex-1 px-6 py-10">
      <div class="mx-auto flex max-w-6xl flex-col gap-8">
        <section class="space-y-4">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <span class="pill inline-flex">Realtime</span>
              <h2 class="mt-2 text-2xl font-semibold text-slate-900">Chọn case để tiếp tục làm việc</h2>
              <p class="text-sm text-slate-500">Những case hiển thị bên dưới được tải trực tiếp từ cơ sở dữ liệu.</p>
            </div>
            <div class="flex items-center gap-3">
              <input
                id="case-search"
                type="search"
                placeholder="Tìm case theo tên hoặc mã..."
                class="w-full rounded-full border border-slate-200 bg-white/90 px-4 py-2 text-sm text-slate-700 placeholder:text-slate-400 focus:border-primary-200 focus:outline-none focus:ring-2 focus:ring-primary-100 sm:w-64"
              />
              <select id="case-filter" class="rounded-full border border-slate-200 bg-white px-4 py-2 text-sm text-slate-600 focus:border-primary-200 focus:outline-none focus:ring-2 focus:ring-primary-100">
                <option value="all">Tất cả</option>
                <option value="new">Mới cập nhật</option>
                <option value="queued">Đang chờ</option>
              </select>
            </div>
          </div>
        </section>

        <section class="rounded-3xl border border-white/60 bg-white/75 p-6 shadow-card">
          <div class="mb-4 flex items-center justify-between">
            <p class="text-sm font-semibold uppercase tracking-[0.35em] text-primary-600">Danh mục Case</p>
            <span id="case-count" class="text-xs font-semibold text-slate-500"></span>
          </div>
          <div id="case-grid" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3"></div>
          <div id="case-empty" class="hidden rounded-2xl border border-dashed border-slate-200 bg-white/70 p-6 text-center text-sm text-slate-500">
            Chưa có case nào trong hệ thống. Hãy <a class="font-semibold text-primary-600" href="/nhap-case">tạo case mới</a> để bắt đầu.
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const grid = document.getElementById("case-grid");
    const emptyState = document.getElementById("case-empty");
    const caseCount = document.getElementById("case-count");
    const searchInput = document.getElementById("case-search");
    const filterSelect = document.getElementById("case-filter");

    const AGENT_API_BASE = "http://127.0.0.1:9000";
    const STORAGE_PREFIX = "case-session:";

    const state = {
      cases: [],
      filtered: []
    };

    const formatTag = (value) => {
      if (!value) return "Khác";
      return value.toString().replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
    };
    
    const sessionStorageKey = (sessionId) => `${STORAGE_PREFIX}${sessionId}`;

    async function callApiSession(caseId, userAction) {
      try {
        const response = await fetch(`${AGENT_API_BASE}/api/agent/sessions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            case_id: caseId,
            user_action: userAction,
          }),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error("❌ Lỗi khi gọi API:", error);
      }
    }

    const persistSessionPayload = (payload) => {
      if (!payload || !payload.session_id) return;
      try {
        sessionStorage.setItem(
          sessionStorageKey(payload.session_id),
          JSON.stringify({
            session_id: payload.session_id,
            case_id: payload.case_id,
            state: payload.state,
            saved_at: Date.now(),
          })
        );
      } catch (error) {
        console.warn("Không thể lưu session vào sessionStorage:", error);
      }
    };

    const deleteCaseById = async (caseId) => {
      const normalizedId = (caseId || "").trim();
      if (!normalizedId) throw new Error("case_id không hợp lệ.");

      try {
        const response = await fetch(`/api/cases/${encodeURIComponent(normalizedId)}`, {
          method: "DELETE",
        });

        if (!response.ok) {
          const message =
            response.status === 404
              ? `Case '${normalizedId}' không tồn tại hoặc đã bị xóa.`
              : `Không thể xóa case '${normalizedId}'. (HTTP ${response.status})`;
          throw new Error(message);
        }
      } catch (error) {
        if (error instanceof Error) throw error;
        throw new Error("Không thể xóa case lúc này.");
      }
    };

    const buildCard = (item) => {
      const wrapper = document.createElement("div");
      wrapper.className = "group relative";

      const anchor = document.createElement("a");
      anchor.className = "flex flex-col gap-3 rounded-2xl border border-slate-100 bg-white/90 p-5 shadow-card transition hover:-translate-y-1 hover:border-primary-200 hover:shadow-lg";
      anchor.href = `/chatframe?case_id=${encodeURIComponent(item.case_id || "")}`;
      anchor.setAttribute("data-status", (item.status || "queued").toLowerCase());
      anchor.setAttribute("data-topic", (item.topic || "").toLowerCase());
      anchor.setAttribute("data-case-id", (item.case_id || "").toLowerCase());

      const deleteButton = document.createElement("button");
      deleteButton.type = "button";
      deleteButton.className = "absolute right-4 top-4 z-10 inline-flex items-center rounded-full border border-slate-200 bg-white/95 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-500 opacity-0 shadow-sm transition duration-200 hover:border-red-200 hover:bg-red-50 hover:text-red-600 focus-visible:opacity-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-200 group-hover:opacity-100";
      deleteButton.textContent = "Xóa";
      deleteButton.setAttribute("aria-label", `Xóa case ${item.case_id || ""}`);

      deleteButton.addEventListener("click", async (event) => {
        event.preventDefault();
        event.stopPropagation();
        if (!item.case_id) return;

        const confirmed = confirm(`Bạn có chắc muốn xóa case '${item.case_id}'?`);
        if (!confirmed) return;

        const originalLabel = deleteButton.textContent;
        deleteButton.disabled = true;
        deleteButton.classList.add("cursor-wait");
        deleteButton.textContent = "Đang xóa...";

        try {
          await deleteCaseById(item.case_id);
          removeCaseFromState(item.case_id);
        } catch (error) {
          console.error(error);
          alert(error instanceof Error ? error.message : "Không thể xóa case. Vui lòng thử lại.");
        } finally {
          deleteButton.disabled = false;
          deleteButton.classList.remove("cursor-wait");
          deleteButton.textContent = originalLabel;
        }
      });

      wrapper.appendChild(anchor);
      wrapper.appendChild(deleteButton);

      const badge = document.createElement("span");
      badge.className = "inline-flex w-fit items-center gap-2 rounded-full border border-primary-100 bg-primary-50 px-3 py-1 text-xs font-semibold text-primary-600";
      badge.textContent = item.case_id || "Case";
      anchor.appendChild(badge);

      const title = document.createElement("h3");
      title.className = "text-lg font-semibold text-slate-900 group-hover:text-primary-600";
      title.textContent = item.topic || "Chưa có tiêu đề";
      anchor.appendChild(title);

      const desc = document.createElement("p");
      desc.className = "line-clamp-3 text-sm text-slate-600";
      desc.textContent = item.summary || "Chưa có mô tả cho case này.";
      anchor.appendChild(desc);

      const meta = document.createElement("div");
      meta.className = "case-meta";
      if (item.location) meta.appendChild(document.createElement("span")).textContent = item.location;
      if (item.time) meta.appendChild(document.createElement("span")).textContent = item.time;
      if (item.status) meta.appendChild(document.createElement("span")).textContent = formatTag(item.status);
      if (meta.childElementCount) anchor.appendChild(meta);

      anchor.addEventListener("click", async (event) => {
        if (!item.case_id) return;

        anchor.classList.add("pointer-events-none", "opacity-70");
        try {
          const result = await callApiSession(item.case_id, "Bắt đầu nhiệm vụ.");
          if (result?.session_id) {
            persistSessionPayload(result);
            window.location.href = `/chatframe?case_id=${encodeURIComponent(result.case_id)}&session_id=${result.session_id}`;
          } else {
            alert("Không thể tạo session cho case này. Vui lòng thử lại.");
          }
        } catch (error) {
          console.error(error);
          alert("Có lỗi xảy ra khi tạo session. Vui lòng thử lại.");
        } finally {
          anchor.classList.remove("pointer-events-none", "opacity-70");
        }
      });

      return wrapper;
    };

    const render = () => {
      if (!grid) return;
      grid.innerHTML = "";

      if (!state.filtered.length) {
        emptyState?.classList.remove("hidden");
        if (caseCount) caseCount.textContent = "0 case";
        return;
      }

      emptyState?.classList.add("hidden");
      state.filtered.forEach((item) => grid.appendChild(buildCard(item)));
      if (caseCount) caseCount.textContent = `${state.filtered.length} case`;
    };

    const applyFilter = () => {
      const query = (searchInput?.value || "").toLowerCase().trim();
      const status = filterSelect?.value || "all";

      state.filtered = state.cases.filter((item) => {
        const matchesQuery = !query ||
          (item.topic || "").toLowerCase().includes(query) ||
          (item.case_id || "").toLowerCase().includes(query);
        const matchesStatus = status === "all" || (item.status || "queued").toLowerCase() === status;
        return matchesQuery && matchesStatus;
      });

      render();
    };

    const removeCaseFromState = (caseId) => {
      if (!caseId) return;
      const normalizedId = caseId.toLowerCase();
      state.cases = state.cases.filter(
        (item) => (item.case_id || "").toLowerCase() !== normalizedId
      );
      applyFilter();
    };

    const loadCases = async () => {
      try {
        const response = await fetch("/api/cases");
        if (!response.ok) throw new Error(`Fetch failed with ${response.status}`);
        const data = await response.json();
        state.cases = Array.isArray(data?.cases) ? data.cases : [];
        state.filtered = [...state.cases];
        render();
      } catch (error) {
        console.error(error);
        state.cases = [];
        state.filtered = [];
        render();
      }
    };

    searchInput?.addEventListener("input", applyFilter);
    filterSelect?.addEventListener("change", applyFilter);

    document.addEventListener("DOMContentLoaded", loadCases);
  </script>
</body>
</html>
